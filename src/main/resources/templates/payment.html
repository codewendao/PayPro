<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜é¡µé¢</title>

    <!-- å¼•å…¥Vue 3 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- å¼•å…¥APIé…ç½® -->
    <script src="assets/js/api-config.js"></script>
    <!-- å¼•å…¥HTTPå·¥å…· -->
    <script src="assets/js/http-util.js"></script>
    <!-- å¼•å…¥QRCode.jsåº“ç”ŸæˆäºŒç»´ç  -->
    <script src="assets/js/qcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            color: #333;
        }
        
        .nav-tab.active {
            background: #007bff;
            color: white;
        }
        
        .page-content {
            padding: 30px;
            min-height: 500px;
        }
        
        /* æ”¯ä»˜é¡µé¢æ ·å¼ */
        .payment-page {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        
        .payment-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            margin: -30px -30px 30px -30px;
        }
        
        .payment-money {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .payment-method-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .qr-code-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 30px 0;
        }
        
        .qr-code {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .qr-image {
            max-width: 200px;
            width: 200px;
            height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .payment-tips {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        
        .payment-tips h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .payment-tips ol {
            text-align: left;
            margin: 0;
            padding-left: 20px;
            line-height: 1.6;
        }
        
        .countdown {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: #dc3545;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            opacity: 0.8;
        }
        
        /* å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†æ ·å¼ */
        .wechat-notice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .wechat-notice-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .wechat-notice-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        
        .wechat-notice-close:hover {
            color: #333;
        }
        
        .wechat-notice-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .wechat-notice-content {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .wechat-notice-text {
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            margin-bottom: 15px;
        }
        
        .wechat-paynum {
            color: #e74c3c;
            font-weight: bold;
            font-size: 18px;
        }
        
        .wechat-notice-image {
            text-align: center;
            margin: 20px 0;
        }
        
        .wechat-notice-image img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        
        .wechat-notice-btn {
            background: #1AAD19;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            float: right;
            margin-top: 15px;
        }
        
        .wechat-notice-btn:hover {
            background: #179B16;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>ğŸ’³ æ”¯ä»˜é¡µé¢</h1>
            </div>
            
            <div class="main-content">
                <nav class="nav-tabs">
                    <a href="recharge.html" class="nav-tab">ğŸ’° å……å€¼</a>
<!--                    <a href="history.html" class="nav-tab">ğŸ“‹ æèµ è®°å½•</a>-->
                    <a href="help.html" class="nav-tab">â“ å¸®åŠ©ä¸­å¿ƒ</a>
                </nav>
                
                <div class="page-content">
                    <div class="payment-page">
                        <div class="payment-header">
                            <div class="payment-method-info">
                                <span>{{ paymentIcon }}</span>
                                <span>{{ payTypeName }}</span>
                            </div>
                            <div class="payment-money">ï¿¥{{ orderInfo.money }}</div>
                            <div>è®¢å•å·ï¼š{{ orderInfo.orderId }}</div>
                            <div v-if=" orderInfo.payNum != 'undefined' ">è®¢å•ç¼–å·ï¼š{{ orderInfo.payNum }}</div>
                            <div v-if="payType === 'Wechat'">æ”¯ä»˜æ—¶è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ‚¨çš„è®¢å•æ ‡è¯†å·ï¼š<span style="color: red">{{ orderInfo.payNum }}</span></div>

                        </div>

                        <!-- äºŒç»´ç æ˜¾ç¤ºåŒºåŸŸ -->
                        <div class="qr-code-container">

                            <h3 v-if="paymentStatus == 'pending'" style="margin-bottom: 20px; color: #333;">è¯·ä½¿ç”¨ {{ payTypeName }} æ‰«ç æ”¯ä»˜</h3>
                            <h3 v-if="paymentStatus == 'success'" style="margin-bottom: 20px; color: #333;"> æ”¯ä»˜æˆåŠŸ~ </h3>

                            <div v-if="paymentStatus == 'pending'" class="qr-code">
                                <!-- å¾®ä¿¡æ”¯ä»˜æ˜¾ç¤ºå›¾ç‰‡ -->
                                <img v-if="(orderInfo.payType === 'Wechat' || orderInfo.payType === 'Alipay' || orderInfo.payType === 'Wechat_zs') && qrImageUrl"
                                     :src="qrImageUrl" 
                                     class="qr-image" 
                                     alt="å¾®ä¿¡æ”¯ä»˜äºŒç»´ç "
                                     @error="handleImageError"
                                     @load="handleImageLoad" />
                                
                                <!-- æ”¯ä»˜å®ç­‰å…¶ä»–æ”¯ä»˜æ–¹å¼æ˜¾ç¤ºcanvas -->
                                <canvas v-else 
                                        id="qrcode-canvas" 
                                        width="200" 
                                        height="200" 
                                        style="border: 1px solid #ddd;"></canvas>
                            </div>

                            <div v-if="paymentStatus == 'success'" class="qr-code">
                                <!-- æ”¯ä»˜æˆåŠŸåï¼ŒäºŒç»´ç ç•Œé¢æ˜¾ç¤ºæˆåŠŸ -->
                                <img src="/assets/images/success.png"/>
                            </div>

                            <div v-if="paymentStatus == 'pending'" class="countdown" style="margin-top: 15px;">
                                <span>â°</span>
                                <span>å‰©ä½™æ—¶é—´ï¼š{{ formatCountdown }}</span>
                            </div>

                            <div v-if="paymentStatus == 'timeout'" class="countdown" style="margin-top: 15px;">
                                <span>â°</span>
                                <span>è®¢å•å·²è¶…æ—¶</span>
                            </div>

                            <div v-if="paymentStatus == 'failed'" class="countdown" style="margin-top: 15px;">
                                <span>â°</span>
                                <span>è®¢å•å¤±è´¥</span>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>&copy; å……å€¼ä¸­å¿ƒ - å®‰å…¨å¯é çš„æ”¯ä»˜æœåŠ¡</p>
            </div>
        </div>
        
        <!-- å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡† -->
        <div v-if="showWechatNotice" class="wechat-notice-overlay" @click.self="closeWechatNotice">
            <div class="wechat-notice-modal">
                <button class="wechat-notice-close" @click="closeWechatNotice">Ã—</button>
                
                <div class="wechat-notice-title">è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ”¯ä»˜æ ‡è¯†å·</div>
                
                <div class="wechat-notice-content">
                    <div class="wechat-notice-text">
                        æ”¯ä»˜æ—¶è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ‚¨çš„è®¢å•æ ‡è¯†å·ï¼š
                        <span class="wechat-paynum">{{ orderInfo.payNum }}</span>
                    </div>
                    <div class="wechat-notice-text">
                        è‹¥å¿˜è®°è¾“å…¥æˆ–è¾“å…¥é”™è¯¯å¯èƒ½ä¼šé€ æˆæ‚¨æ”¯ä»˜å¤±è´¥ï¼
                    </div>
                    
                    <div class="wechat-notice-image">
                        <img src="assets/images/wxremark.png" alt="å¾®ä¿¡æ”¯ä»˜å¤‡æ³¨ç¤ºä¾‹" />
                    </div>
                </div>
                
                <button class="wechat-notice-btn" @click="closeWechatNotice">çŸ¥é“äº†</button>
                <div style="clear: both;"></div>
            </div>
        </div>

        <div v-if="showAlipayNotice" class="wechat-notice-overlay" @click.self="closeAlipayNotice">
            <div class="wechat-notice-modal">
                <button class="wechat-notice-close" @click="closeWechatNotice">Ã—</button>

                <div class="wechat-notice-title">è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ”¯ä»˜æ ‡è¯†å·</div>

                <div class="wechat-notice-content">
                    <div class="wechat-notice-text">
                        æ”¯ä»˜æ—¶è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ‚¨çš„è®¢å•æ ‡è¯†å·ï¼š
                        <span class="wechat-paynum">{{ orderInfo.payNum }}</span>
                    </div>
                    <div class="wechat-notice-text">
                        è‹¥å¿˜è®°è¾“å…¥æˆ–è¾“å…¥é”™è¯¯å¯èƒ½ä¼šé€ æˆæ‚¨æ”¯ä»˜å¤±è´¥ï¼
                    </div>

                    <div class="wechat-notice-image">
                        <img src="assets/images/aliremark.png" alt="æ”¯ä»˜å®æ”¯ä»˜å¤‡æ³¨ç¤ºä¾‹" />
                    </div>
                </div>

                <button class="wechat-notice-btn" @click="closeAlipayNotice">çŸ¥é“äº†</button>
                <div style="clear: both;"></div>
            </div>
        </div>

        <div v-if="showWechatZsNotice" class="wechat-notice-overlay" @click.self="closeWechatNotice">
            <div class="wechat-notice-modal">
                <button class="wechat-notice-close" @click="closeWechatNotice">Ã—</button>

                <div class="wechat-notice-title">è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ”¯ä»˜æ ‡è¯†å·</div>

                <div class="wechat-notice-content">
                    <div class="wechat-notice-text">
                        æ”¯ä»˜æ—¶è¯·åœ¨å¤‡æ³¨ä¸­è¾“å…¥æ‚¨çš„è®¢å•æ ‡è¯†å·ï¼š
                        <span class="wechat-paynum">{{ orderInfo.payNum }}</span>
                    </div>
                    <div class="wechat-notice-text">
                        è‹¥å¿˜è®°è¾“å…¥æˆ–è¾“å…¥é”™è¯¯å¯èƒ½ä¼šé€ æˆæ‚¨æ”¯ä»˜å¤±è´¥ï¼
                    </div>

                    <div class="wechat-notice-image">
                        <img src="assets/images/wxzsremark.png" alt="å¾®ä¿¡æ”¯ä»˜å¤‡æ³¨ç¤ºä¾‹" />
                    </div>
                </div>

                <button class="wechat-notice-btn" @click="closeWechatZsNotice">çŸ¥é“äº†</button>
                <div style="clear: both;"></div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    orderInfo: {},
                    qrCodeUrl: '',
                    qrImageUrl: '',
                    countdown: 300, // 5åˆ†é’Ÿå€’è®¡æ—¶
                    countdownTimer: null,
                    paymentStatus: 'pending', // pending, success, failed, timeout
                    loading: false, // ä¿®æ”¹ä¸ºfalseï¼Œè®©DOMç«‹å³æ¸²æŸ“
                    showWechatNotice: false, // æ§åˆ¶å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†æ˜¾ç¤º
                    showAlipayNotice: false, // æ§åˆ¶å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†æ˜¾ç¤º
                    showWechatZsNotice: false

                }
            },
            computed: {
                formatCountdown() {
                    const minutes = Math.floor(this.countdown / 60);
                    const seconds = this.countdown % 60;
                    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                },
                payTypeName() {
                    const methods = {
                        'Alipay': 'æ”¯ä»˜å®',
                        'Wechat': 'å¾®ä¿¡æ”¯ä»˜',
                    };
                    return methods[this.orderInfo.payType] || 'æœªçŸ¥æ”¯ä»˜æ–¹å¼';
                },
                paymentIcon() {
                    const icons = {
                        'alipay': 'ğŸ”µ',
                        'Wechat': 'ğŸŸ¢',
                        'Alipay_f2f': 'ğŸ’™'
                    };
                    return icons[this.orderInfo.payType] || 'ğŸ’³';
                }
            },
            mounted() {
                this.initPayment();
            },
            beforeUnmount() {
                if (this.countdownTimer) {
                    clearInterval(this.countdownTimer);
                }
            },
            methods: {
                getUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    return {
                        orderId: params.get('orderId'),
                        money: params.get('money') || 100,
                        payType: params.get('payType'),
                        payNum: params.get('payNum') || "",
                        customerQr: params.get('customerQr'), // è‡ªå®šä¹‰äºŒç»´ç ï¼Œåœ¨å¾®ä¿¡æ”¯ä»˜æ—¶ä½¿ç”¨
                        picName: params.get('picName'),
                        qrCode: params.get('qrCode'), // äºŒç»´ç ï¼Œå½“ä¸ºæ”¯ä»˜å®æ‰«ç æ—¶ä½¿ç”¨
                        payQrNum: params.get('payQrNum'),
                    };
                },

                async initPayment() {
                    // ä»URLå‚æ•°è·å–è®¢å•ä¿¡æ¯
                    this.orderInfo = this.getUrlParams();

                    // è°ƒç”¨åå°APIè·å–æ”¯ä»˜ä¿¡æ¯
                    await this.createPaymentOrder();

                    // å¦‚æœæ˜¯å¾®ä¿¡æ”¯ä»˜ï¼Œæ˜¾ç¤ºæç¤ºæ¡†
                    if (this.orderInfo.payType === 'Wechat') {
                        this.showWechatNotice = true;
                    }

                    if (this.orderInfo.payType === 'Alipay') {
                        this.showAlipayNotice = true;
                    }

                    if (this.orderInfo.payType === 'Wechat_zs') {
                        this.showWechatZsNotice = true;
                    }

                    // ç­‰å¾…QRCodeåº“åŠ è½½å®Œæˆ
                    await this.waitForQRCode();

                    // ç­‰å¾…DOMå…ƒç´ æ¸²æŸ“å®Œæˆ
                    await this.$nextTick();

                    // é¢å¤–ç­‰å¾…100msç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // ç”ŸæˆäºŒç»´ç 
                    await this.generateQRCode();

                    // å¼€å§‹å€’è®¡æ—¶
                    this.startCountdown();

                    // å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
                    this.startPaymentPolling();
                    this.loading = false;
                },

                checkDOMElements() {
                    // ç§»é™¤è°ƒè¯•ä¿¡æ¯
                },

                async waitForQRCode() {
                    // ç­‰å¾…QRCodeåº“åŠ è½½ï¼Œæœ€å¤šç­‰å¾10ç§’
                    let attempts = 0;
                    const maxAttempts = 100; // 10ç§’ï¼Œæ¯100msæ£€æŸ¥ä¸€æ¬¡

                    while (attempts < maxAttempts && typeof QRCode === 'undefined') {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }

                    if (typeof QRCode === 'undefined') {
                        console.warn('QRCodeåº“åŠ è½½è¶…æ—¶ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                        // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰CDNéƒ½åŠ è½½å¤±è´¥
                        if (window.qrcodeLoadFailed) {
                            console.error('QRCodeåº“æ— æ³•åŠ è½½ï¼Œå°†æ˜¾ç¤ºæ–‡æœ¬é“¾æ¥');
                        }
                    }
                },

                async createPaymentOrder() {
                    try {
                        console.log('åˆå§‹åŒ–æ”¯ä»˜è®¢å•:', this.orderInfo);
                        if (this.orderInfo.payType === 'Alipay') {
                            // æ”¯ä»˜å®è¿”å›å›¾ç‰‡è·¯å¾„
                            if (this.orderInfo.customerQr === "true") {
                                // è¡¨ç¤ºæ˜¯è‡ªå®šä¹‰é‡‘é¢
                                this.qrImageUrl = "assets/qr/alipay/custom.png";
                            } else {
                                // æ­£å¸¸è®¢å•
                                this.qrImageUrl = `assets/qr/alipay/${this.orderInfo.picName}/${this.orderInfo.payQrNum}.png`;
                            }
                            console.log('æ”¯ä»˜å®æ”¯ä»˜äºŒç»´ç è·¯å¾„:', this.qrImageUrl);
                        } else if (this.orderInfo.payType === 'Wechat') {
                            // å¾®ä¿¡è¿”å›å›¾ç‰‡è·¯å¾„
                            if (this.orderInfo.customerQr === "true") {
                                // è¡¨ç¤ºæ˜¯è‡ªå®šä¹‰é‡‘é¢
                                this.qrImageUrl = "assets/qr/wechat/custom.png";
                            } else {
                                // æ­£å¸¸è®¢å•
                                this.qrImageUrl = `assets/qr/wechat/${this.orderInfo.picName}/${this.orderInfo.payQrNum}.png`;
                            }
                            console.log('å¾®ä¿¡æ”¯ä»˜äºŒç»´ç è·¯å¾„:', this.qrImageUrl);
                        }
                        else if (this.orderInfo.payType === 'Wechat_zs') {
                            // å¾®ä¿¡è¿”å›å›¾ç‰‡è·¯å¾„
                            this.qrImageUrl = "assets/qr/wechatzs/custom.png";
                            console.log('èµèµç ä½¿ç”¨è‡ªå®šä¹‰url:', this.qrImageUrl);
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥:', error);
                        this.paymentStatus = 'failed';
                    }
                },

                async generateQRCode() {
                    if ((this.orderInfo.payType === 'Wechat' || this.orderInfo.payType === 'Alipay'|| this.orderInfo.payType === 'Wechat_zs') && this.qrImageUrl) {
                        // ä½¿ç”¨å›¾ç‰‡æ˜¾ç¤ºï¼Œä¸éœ€è¦ç”ŸæˆcanvasäºŒç»´ç 
                        console.log('ä½¿ç”¨å›¾ç‰‡æ˜¾ç¤º:', this.qrImageUrl);
                        return;
                    }
                    
                    if (!this.qrCodeUrl) {
                        this.showFallbackQRCode();
                        return;
                    }
                    
                    try {
                        // æ£€æŸ¥QRCodeåº“æ˜¯å¦å·²åŠ è½½
                        if (typeof QRCode === 'undefined') {
                            this.showFallbackQRCode();
                            return;
                        }
                        
                        // è·å–canvaså…ƒç´ ï¼Œç­‰å¾…å…ƒç´ æ¸²æŸ“
                        let canvas = document.getElementById('qrcode-canvas');
                        let attempts = 0;
                        
                        // å¦‚æœcanvasæ²¡æœ‰æ‰¾åˆ°ï¼Œç­‰å¾…DOMæ¸²æŸ“
                        while (!canvas && attempts < 10) {
                            await new Promise(resolve => setTimeout(resolve, 100));
                            canvas = document.getElementById('qrcode-canvas');
                            attempts++;
                        }
                        
                        if (!canvas) {
                            console.warn('Canvaså…ƒç´ æœªæ‰¾åˆ°');
                            return;
                        }
                        
                        // ä½¿ç”¨QRCode.jsç”ŸæˆäºŒç»´ç 
                        await QRCode.toCanvas(canvas, this.qrCodeUrl, {
                            width: 200,
                            height: 200,
                            margin: 1,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            }
                        });
                        
                        console.log('äºŒç»´ç ç”ŸæˆæˆåŠŸ');
                        
                    } catch (error) {
                        console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', error);
                        this.showFallbackQRCode();
                    }
                },
                
                showFallbackQRCode() {
                    // ç­‰å¾…ä¸€ä¸‹å†æŸ¥æ‰¾canvaså…ƒç´ 
                    setTimeout(() => {
                        const canvas = document.getElementById('qrcode-canvas');
                        if (!canvas) {
                            return;
                        }
                        
                        const ctx = canvas.getContext('2d');
                        canvas.width = 200;
                        canvas.height = 200;
                        
                        // ç»˜åˆ¶èƒŒæ™¯
                        ctx.fillStyle = '#f8f9fa';
                        ctx.fillRect(0, 0, 200, 200);
                        
                        // ç»˜åˆ¶è¾¹æ¡†
                        ctx.strokeStyle = '#dee2e6';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(1, 1, 198, 198);
                        
                        // ç»˜åˆ¶æ–‡æœ¬
                        ctx.fillStyle = '#495057';
                        ctx.font = 'bold 16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('äºŒç»´ç åŠ è½½ä¸­...', 100, 70);
                        
                        ctx.font = '12px Arial';
                        ctx.fillStyle = '#6c757d';
                        ctx.fillText('è¯·ç¨åæˆ–åˆ·æ–°é¡µé¢', 100, 95);
                        
                        if (this.qrCodeUrl) {
                            ctx.fillText('æ”¯ä»˜é“¾æ¥å·²å‡†å¤‡å¥½', 100, 115);
                        }
                        
                        // ç»˜åˆ¶æç¤ºä¿¡æ¯
                        ctx.fillStyle = '#007bff';
                        ctx.fillRect(50, 160, 100, 25);
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 12px Arial';
                        ctx.fillText('è¯·ç¨åé‡è¯•', 100, 175);
                    }, 200);
                },
                
                startCountdown() {
                    this.countdownTimer = setInterval(() => {
                        this.countdown--;
                        if (this.countdown <= 0) {
                            this.paymentStatus = 'timeout';
                            clearInterval(this.countdownTimer);
                        }
                    }, 1000);
                },
                
                startPaymentPolling() {
                    const pollingTimer = setInterval(async () => {
                        if (this.paymentStatus !== 'pending') {
                            clearInterval(pollingTimer);
                            return;
                        }
                        
                        try {
                            const response = await httpUtil.get(API_CONFIG.ENDPOINTS.STATUS + "/" + this.orderInfo.orderId);
                            if(response.code == 200){
                                if(response.data == 1){
                                    this.paymentStatus = 'success';
                                    clearInterval(this.countdownTimer);
                                    clearInterval(pollingTimer);
                                } else if(response.data == 2) {
                                  this.paymentStatus = 'failed';
                                  clearInterval(pollingTimer);
                                }
                            }

                        } catch (error) {
                            console.error('æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€å¤±è´¥:', error);
                        }
                    }, 2000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
                },
                
                // å¤„ç†å¾®ä¿¡æ”¯ä»˜äºŒç»´ç å›¾ç‰‡åŠ è½½é”™è¯¯
                handleImageError(event) {
                    console.error('æ”¯ä»˜äºŒç»´ç å›¾ç‰‡åŠ è½½å¤±è´¥:', this.qrImageUrl);
                    debugger
                    // å°è¯•å¤‡ç”¨è·¯å¾„
                    if (!event.target.dataset.retried) {
                        if(this.orderInfo.payType == 'Alipay'){
                            event.target.src = 'assets/qr/alipay/custom.png';
                            return
                        }else {
                            event.target.src = 'assets/qr/wechat/custom.png';
                            return
                        }
                    }
                    
                    // æ˜¾ç¤ºé”™è¯¯å ä½å›¾
                    event.target.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4gPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2Y4ZjlmYSIvPiA8dGV4dCB0ZXh0LWFuY2hvcj0ibWlkZGxlIiB4PSI1MCUiIHk9IjQ1JSIgc3R5bGU9ImZpbGw6IzY2Njtmb250LXdlaWdodDpib2xkO2ZvbnQtc2l6ZToxNHB4O2ZvbnQtZmFtaWx5OkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmO2RvbWluYW50LWJhc2VsaW5lOmNlbnRyYWwiPuWbvueJh+WKoOi9vejkuK08L3RleHQ+IDx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjUwJSIgeT0iNjAlIiBzdHlsZT0iZmlsbDojOTk5O2ZvbnQtc2l6ZToxMnB4O2ZvbnQtZmFtaWx5OkFyaWFsLEhlbHZldGljYSxzYW5zLXNlcmlmO2RvbWluYW50LWJhc2VsaW5lOmNlbnRyYWwiPuivt+WIt+aWsOmhtemdojwvdGV4dD4gPC9zdmc+';
                    // æ›´æ–°é¡µé¢çŠ¶æ€æç¤º
                    this.paymentStatus = 'failed';
                },
                
                // å¤„ç†æ”¯ä»˜äºŒç»´ç å›¾ç‰‡åŠ è½½æˆåŠŸ
                handleImageLoad(event) {
                    console.log('æ”¯ä»˜äºŒç»´ç å›¾ç‰‡åŠ è½½æˆåŠŸ:', this.qrImageUrl);
                },

                // å…³é—­å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†
                closeWechatNotice() {
                    this.showWechatNotice = false;
                },

                // å…³é—­å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†
                closeAlipayNotice() {
                    this.showAlipayNotice = false;
                },

                // å…³é—­å¾®ä¿¡æ”¯ä»˜æç¤ºæ¡†
                closeWechatZsNotice() {
                    this.showWechatZsNotice = false;
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>